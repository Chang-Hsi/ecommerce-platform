generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  name               String?
  firstName          String?
  lastName           String?
  passwordHash       String?
  role               UserRole            @default(CUSTOMER)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  profile            UserProfile?
  addresses          UserAddress[]
  authSessions       AuthSession[]
  verificationTokens VerificationToken[]
  carts              Cart[]
  favorites          Favorite[]
  orders             Order[]

  @@index([role])
}

model UserProfile {
  id                String             @id @default(cuid())
  userId            String             @unique
  birthday          DateTime?
  country           String?
  city              String?
  district          String?
  postalCode        String?
  shoeSize          String?
  primaryPreference PrimaryPreference?
  otherPreferences  String[]           @default([])
  measurementUnit   MeasurementUnit    @default(METRIC)
  displayName       String?
  avatarText        String?
  avatarUrl         String?
  reviewVisibility  ReviewVisibility   @default(COMMUNITY)
  locationSharing   LocationSharing    @default(NONE)
  adsByUsageData    Boolean            @default(true)
  adsByProfileData  Boolean            @default(true)
  useFitnessData    Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([country, city, district])
}

model UserAddress {
  id             String   @id @default(cuid())
  userId         String
  recipientLastName String
  recipientFirstName String
  phone          String
  country        String
  city           String
  district       String
  addressLine1   String
  postalCode     String
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingOrders Order[]  @relation("OrderShippingAddress")
  billingOrders  Order[]  @relation("OrderBillingAddress")

  @@index([userId, isDefault])
  @@index([country, city, district, postalCode])
}

model AuthSession {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model VerificationToken {
  id         String              @id @default(cuid())
  userId     String?
  email      String
  purpose    VerificationPurpose
  codeHash   String
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime            @default(now())
  user       User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email, purpose, expiresAt])
  @@index([userId, purpose])
}

model Product {
  id             String           @id @default(cuid())
  slug           String           @unique
  name           String
  subtitle       String
  description    String?
  brand          String
  category       String
  audience       Audience
  gender         Gender
  status         ProductStatus    @default(ACTIVE)
  badgeLabel     String?
  basePrice      Decimal          @db.Decimal(10, 2)
  compareAtPrice Decimal?         @db.Decimal(10, 2)
  imageRatio     String?
  sports         String[]         @default([])
  fitTags        String[]         @default([])
  featureTags    String[]         @default([])
  techTags       String[]         @default([])
  colorTags      String[]         @default([])
  isFeatured     Boolean          @default(false)
  isSale         Boolean          @default(false)
  releaseAt      DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  images         ProductImage[]
  variants       ProductVariant[]
  favorites      Favorite[]
  cartItems      CartItem[]
  orderItems     OrderItem[]

  @@index([status, releaseAt(sort: Desc)])
  @@index([category, audience, gender, status])
  @@index([brand, status])
  @@index([isSale, status])
  @@index([isFeatured, status])
  @@index([basePrice])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  src       String
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, sortOrder])
  @@index([productId])
}

model ProductVariant {
  id             String      @id @default(cuid())
  productId      String
  sku            String      @unique
  colorLabel     String
  sizeLabel      String
  unitPrice      Decimal     @db.Decimal(10, 2)
  compareAtPrice Decimal?    @db.Decimal(10, 2)
  stockQty       Int         @default(0)
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  product        Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems      CartItem[]
  orderItems     OrderItem[]

  @@unique([productId, colorLabel, sizeLabel])
  @@index([productId, isActive, stockQty])
  @@index([sizeLabel, isActive])
  @@index([colorLabel, isActive])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId, createdAt(sort: Desc)])
}

model Cart {
  id            String     @id @default(cuid())
  userId        String
  status        CartStatus @default(ACTIVE)
  currency      String     @default("TWD")
  promoCode     String?
  promoDiscount Decimal    @default(0) @db.Decimal(10, 2)
  shippingFee   Decimal    @default(0) @db.Decimal(10, 2)
  serviceFee    Decimal    @default(0) @db.Decimal(10, 2)
  checkedOutAt  DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         CartItem[]
  order         Order?

  @@index([userId, status, updatedAt(sort: Desc)])
}

model CartItem {
  id             String         @id @default(cuid())
  cartId         String
  productId      String
  variantId      String
  qty            Int            @default(1)
  unitPrice      Decimal        @db.Decimal(10, 2)
  compareAtPrice Decimal?       @db.Decimal(10, 2)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  cart           Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product        Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant        ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)

  @@unique([cartId, variantId])
  @@index([cartId, createdAt(sort: Desc)])
  @@index([productId])
}

model PromoCode {
  id            String       @id @default(cuid())
  code          String       @unique
  discountType  DiscountType
  discountValue Decimal      @db.Decimal(10, 2)
  isActive      Boolean      @default(true)
  startsAt      DateTime?
  endsAt        DateTime?
  usageLimit    Int?
  usedCount     Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  orders        Order[]

  @@index([isActive, startsAt, endsAt])
}

model Order {
  id                  String           @id @default(cuid())
  userId              String
  cartId              String?          @unique
  promoCodeId         String?
  status              OrderStatus      @default(PENDING_PAYMENT)
  paymentMethod       PaymentMethod?
  paymentStatus       PaymentStatus    @default(PENDING)
  email               String
  firstName           String
  lastName            String
  phone               String
  shippingAddressId   String?
  billingAddressId    String?
  shippingAddressText String?
  billingAddressText  String?
  subtotal            Decimal          @db.Decimal(10, 2)
  originalSubtotal    Decimal          @db.Decimal(10, 2)
  promoDiscount       Decimal          @default(0) @db.Decimal(10, 2)
  shippingFee         Decimal          @default(0) @db.Decimal(10, 2)
  total               Decimal          @db.Decimal(10, 2)
  savings             Decimal          @default(0) @db.Decimal(10, 2)
  currency            String           @default("TWD")
  deliveryWindowLabel String?
  placedAt            DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  user                User             @relation(fields: [userId], references: [id], onDelete: Restrict)
  cart                Cart?            @relation(fields: [cartId], references: [id], onDelete: SetNull)
  promoCode           PromoCode?       @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)
  shippingAddress     UserAddress?     @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id], onDelete: SetNull)
  billingAddress      UserAddress?     @relation("OrderBillingAddress", fields: [billingAddressId], references: [id], onDelete: SetNull)
  items               OrderItem[]
  paymentAttempts     PaymentAttempt[]

  @@index([userId, status, createdAt(sort: Desc)])
  @@index([paymentStatus, createdAt(sort: Desc)])
}

model OrderItem {
  id                 String          @id @default(cuid())
  orderId            String
  productId          String?
  variantId          String?
  nameSnapshot       String
  subtitleSnapshot   String?
  imageSrcSnapshot   String?
  colorLabelSnapshot String?
  sizeLabelSnapshot  String?
  qty                Int
  unitPrice          Decimal         @db.Decimal(10, 2)
  compareAtPrice     Decimal?        @db.Decimal(10, 2)
  lineTotal          Decimal         @db.Decimal(10, 2)
  createdAt          DateTime        @default(now())
  order              Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product            Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant            ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
}

model PaymentAttempt {
  id          String        @id @default(cuid())
  orderId     String
  provider    PaymentMethod
  status      PaymentStatus
  amount      Decimal       @db.Decimal(10, 2)
  currency    String        @default("TWD")
  providerRef String?
  errorCode   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt(sort: Desc)])
  @@index([provider, status])
}

model PaymentWebhookEvent {
  id         String    @id @default(cuid())
  provider   String
  eventId    String    @unique
  eventType  String
  orderId    String?
  processedAt DateTime?
  lastError  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([provider, eventType, createdAt(sort: Desc)])
  @@index([orderId, createdAt(sort: Desc)])
}

enum UserRole {
  CUSTOMER
  ADMIN
}

enum VerificationPurpose {
  LOGIN
  REGISTER
  PASSWORD_RESET
}

enum ProductStatus {
  DRAFT
  ACTIVE
  UPCOMING
  ARCHIVED
}

enum Audience {
  ADULT
  KIDS
}

enum Gender {
  MEN
  WOMEN
  UNISEX
}

enum CartStatus {
  ACTIVE
  CHECKED_OUT
  ABANDONED
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  FAILED
  CANCELED
  REFUNDED
}

enum PaymentMethod {
  CARD
  PAYPAL
  GPAY
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum DiscountType {
  FIXED
  PERCENT
}

enum PrimaryPreference {
  WOMEN
  MEN
}

enum MeasurementUnit {
  METRIC
  IMPERIAL
}

enum ReviewVisibility {
  PRIVATE
  COMMUNITY
  PUBLIC
}

enum LocationSharing {
  FRIENDS
  NONE
}
